---
description: prompts/と脚本をもとにimages/内の画像ファイル名を連番にリネーム
---

# 画像ファイル名リネーム

prompts/フォルダ内のプロンプトファイルと対応させて、images/フォルダ内の画像ファイルを連番（1.png, 2.png, ...）にリネームします。

## 引数

- `$ARGUMENTS`: imagesフォルダパス（例: `datas/history/grade2/4-1/4nobunaga_hideyoshi/story/story1/images`）

---

## フェーズ1: 現状確認

### 1.1 フォルダ構造の確認

```bash
ls -la [imagesフォルダパス]/
ls -la [imagesフォルダパス]/../prompts/
```

### 1.2 ファイル数の照合

- images/内の画像ファイル数をカウント（.png, .jpg, .jpeg, .webp）
- prompts/内の.txtファイル数をカウント
- 数が一致するか確認

**不一致の場合**: ユーザーに確認を求める

### 1.3 プロンプト内容の確認

各プロンプトファイルを読み込み、シーン内容を把握:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## プロンプト一覧

【1.txt】[日本語訳の要約]
【2.txt】[日本語訳の要約]
...

画像ファイル数: [N]枚
プロンプト数: [M]枚
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## フェーズ2: 画像とプロンプトの照合

### 2.1 全画像の読み込み

Readツールで全画像ファイルを読み込み、視覚的に内容を確認する。

### 2.2 プロンプトとの照合

各画像の内容を分析し、prompts/内のどのプロンプトに対応するかを判定:

**照合基準**:
- プロンプトに記載された主要な被写体（人物、場面）
- 背景・環境の特徴
- 構図やアクション
- 日本語訳がある場合はそれを参考に

### 2.3 対応表の生成と表示

照合結果を対応表として表示:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 画像とプロンプトの照合結果

[元ファイル名A]（[画像内容の要約]）→ [対応するプロンプト番号].png
[元ファイル名B]（[画像内容の要約]）→ [対応するプロンプト番号].png
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2.4 確認なしで実行

照合結果に基づいて自動的にリネームを実行する（確認不要）。

---

## フェーズ3: リネーム実行

### 3.1 リネーム実行

ファイル名の衝突がある場合のみ一時ファイル名を経由する。衝突がない場合は直接リネーム。

**衝突チェック**: 元ファイル名と目標ファイル名が重複する場合のみ一時ファイルを使用

```bash
# 衝突がない場合: 直接リネーム
mv "[元ファイル]" "[フォルダ]/1.png"
mv "[元ファイル]" "[フォルダ]/2.png"

# 衝突がある場合のみ: 該当ファイルだけ一時名を経由
mv "[衝突する元ファイル]" "[フォルダ]/_tmp_1.png"
mv "[フォルダ]/_tmp_1.png" "[フォルダ]/1.png"
```

### 3.2 拡張子の統一

元の拡張子を保持する（.png → .png, .jpg → .jpg）

---

## フェーズ4: 脚本への画像番号追記

### 4.1 脚本の各行と画像の対応付け

脚本の各行の内容を分析し、どの画像（プロンプト）が対応するかを判定:

**対応付け基準**:
- 行の内容（人物、場面、出来事）とプロンプトの内容を照合
- 連続する行が同じシーンの場合は同じ画像番号
- N1, N2, N3などのナレーション区切りを考慮

### 4.2 画像番号の追記

各行の末尾に `[番号]` 形式で画像番号を追記:

```
N1：〇〇が△△だったころ [1]
□□が××に対し [2]
...
```

### 4.3 ファイルの更新

Editツールでkyakuhon.txtを更新する。

---

## フェーズ5: 完了報告

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
## 完了

リネーム結果:

[元のファイル名1] → 1.png ✓
[元のファイル名2] → 2.png ✓
...

脚本への画像番号追記:
行1: [1] [シーン概要]
行2: [2] [シーン概要]
...

保存先: [imagesフォルダパス]/
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 出力ファイル構造

```
[storyフォルダ]/
├── kyakuhon.txt      (各行に [番号] を追記)
├── prompts/
│   ├── 1.txt  ←→  images/1.png
│   ├── 2.txt  ←→  images/2.png
│   └── ...
└── images/
    ├── 1.png  (リネーム後)
    ├── 2.png  (リネーム後)
    └── ...
```

### kyakuhon.txt 更新後の例

```
N1：織田信長が尾張の小さな戦国大名だったころ [1]
約2万5千の大軍を率いる今川義元に対し [2]
信長の兵は3千〜5千人ほどしかいなかった。 [2]
N2:序盤は当然苦戦したが、今川軍の油断と激しい雨が降った隙を逃さず、[3]
信長は奇襲攻撃をしかけ、今川義元に逆転勝利 [4]
...
```

---

## 重要なルール

1. **画像内容で照合** - アルファベット順や日時順ではなく、画像の内容をプロンプトと照合して対応付け
2. **全画像を読み込む** - Readツールで全画像を視覚的に確認してから照合
3. **拡張子保持** - 元の拡張子をそのまま使用
4. **衝突時のみ一時名使用** - ファイル名衝突がある場合のみ`_tmp_`プレフィックスの一時ファイルを経由（衝突がなければ直接リネーム）
5. **プロンプトとの対応** - 番号はprompts/内のファイル番号と一致
